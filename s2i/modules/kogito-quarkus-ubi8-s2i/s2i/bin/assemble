#!/bin/bash -e
#
# S2I assemble script for the 'kaas-quarkus-centos-s2i' image.
# The 'assemble' script builds your application source so that it is ready to run.
#
# For more information refer to the documentation:
#	https://github.com/openshift/source-to-image/blob/master/docs/builder_image.md
#
#############################################
# Configure maven - for a complete list of
# supported values, please refer the module.yaml
# file.

CONFIGURE_SCRIPTS=(
  ${KOGITO_HOME}/launch/configure-maven.sh
  ${KOGITO_HOME}/launch/memory-limit.sh
)
source ${KOGITO_HOME}/launch/configure.sh
#############################################

# If the 'kogito-quarkus-ubi8-s2i' assemble script is executed with the '-h' flag, print the usage.
if [[ "$1" == "-h" ]]; then
    exec /usr/libexec/s2i/usage
fi

######################
# incremental builds
# import ${KOGITO_HOME}/launch/configure-maven.sh
manage_incremental_build

echo "---> Installing application source..."
cd /tmp/src/

if [ -f "pom.xml" ]; then

    nativeBuild="-Pnative"
    if [ "${NATIVE^^}" == "FALSE" ]; then
        nativeBuild=""
    fi

    echo "---> Building application from source..."
    $MAVEN_HOME/bin/mvn clean package ${KOGITO_OPTS} ${nativeBuild} -s $KOGITO_HOME/.m2/settings.xml \
        -DskipTests -Dmaven.javadoc.skip=true -Dmaven.site.skip=true -Dmaven.source.skip=true \
        -Djacoco.skip=true -Dcheckstyle.skip=true -Dfindbugs.skip=true -Dpmd.skip=true -Dfabric8.skip=true
else
    echo "---> Generating project structure..."

    $MAVEN_HOME/bin/mvn archetype:generate -B -DarchetypeGroupId=org.kie.kogito -DarchetypeArtifactId=kogito-quarkus-archetype \
	-DarchetypeVersion=8.0.0-SNAPSHOT -DgroupId=com.company -DartifactId=project -s $KOGITO_HOME/.m2/settings.xml

    # copy resources into the generated project
    for item in *
    do
        if [ -d $item ] && [ "$item" == "project" ]; then
            echo "--> Skipping generated project ..."
        else
            echo "--> Coping resource $item"
            cp -R $item project/src/main/resources
        fi
    done

    # move all project content into the current directory
    mv project/* .

    echo "---> Building application from source..."
    $MAVEN_HOME/bin/mvn clean package ${KOGITO_OPTS} ${nativeBuild} -s $KOGITO_HOME/.m2/settings.xml \
        -DskipTests -Dmaven.javadoc.skip=true -Dmaven.site.skip=true -Dmaven.source.skip=true \
        -Djacoco.skip=true -Dcheckstyle.skip=true -Dfindbugs.skip=true -Dpmd.skip=true -Dfabric8.skip=true
fi

if [ "${NATIVE^^}" == "FALSE" ]; then
    cp -v target/*-runner.jar $KOGITO_HOME/bin
    cp -r target/lib/ $KOGITO_HOME/bin/
else
    echo "---> Installing application binaries"
    cp -v target/*-runner $KOGITO_HOME/bin
    chmod +x $KOGITO_HOME/bin/*-runner
    echo "---> Copy native java libraries for ssl handling..."
    cp -v $GRAALVM_HOME/jre/lib/amd64/libsunec.so $KOGITO_HOME/bin
fi


echo "---> Copy image metadata file..."
if [ -e /tmp/src/target/image_metadata.json ]; then
    mkdir /tmp/.s2i
    cp -v /tmp/src/target/image_metadata.json /tmp/.s2i
    cp -v /tmp/src/target/image_metadata.json $KOGITO_HOME/bin
else
    echo "-----> Failed to copy metadata file, /tmp/src/target/image_metadata.json not found."
fi

